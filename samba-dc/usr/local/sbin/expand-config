#!/bin/bash

#
# Copyright (C) 2022 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#

set -e

REALM=${REALM:?}
IPADDRESS=${IPADDRESS:?}
HOSTNAME=${HOSTNAME:?}
NBDOMAIN=${NBDOMAIN:?}

cat - > /etc/krb5.conf <<EOF
# generated by $0
[libdefaults]
        default_realm = ${REALM^^}
        dns_lookup_realm = false
        dns_lookup_kdc = true

[realms]
${REALM^^} = {
        default_domain = ${REALM,,}
}

[domain_realm]
        ${REALM,,} = ${REALM^^}
EOF

cat - > /etc/hosts <<EOF
127.0.0.1     localhost.localdomain localhost
${IPADDRESS}     ${HOSTNAME}
EOF

cat - > /etc/resolv.conf <<EOF
search ${REALM,,}
nameserver ${IPADDRESS}
EOF

cat - > /etc/samba/include.conf <<EOF
[global]
log level = ${SAMBA_LOGLEVEL}
EOF

# Overwrite/Regenerate smb.conf if server role value is not expected.
# This happens during import-module, but can be useful to reset smb.conf
# to a safe default, too: just remove smb.conf and it is generated again.
conf_realm=$(testparm -l -s  /etc/samba/smb.conf --parameter-name='realm' 2>/dev/null)
if [[ -n "${REALM}" ]] && [[ "${conf_realm,,}" != "${REALM,,}" ]] ; then
        nbname=$(hostname -s)
        mkdir -vp "/var/lib/samba/sysvol/${REALM,,}/scripts"
        cat - >/etc/samba/smb.conf <<EOF
# Generated by expand-config. This file is re-created by the container
# entrypoint, if it is missing: manual changes to this file are retained.
[global]
        ${PREFIXLEN:+disable netbios = Yes}
        bind interfaces only = Yes
        interfaces = 127.0.0.1 ${IPADDRESS}${PREFIXLEN:+/}${PREFIXLEN}
        netbios name = ${nbname^^}
        realm = ${REALM^^}
        server role = active directory domain controller
        workgroup = ${NBDOMAIN}
        include = /etc/samba/include.conf

[sysvol]
        path = /var/lib/samba/sysvol
        read only = No

[netlogon]
        path = /var/lib/samba/sysvol/${REALM,,}/scripts
        read only = No
EOF
fi
